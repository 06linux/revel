---
layout: godoc
---
<!--
	Copyright 2009 The Go Authors. All rights reserved.
	Use of this source code is governed by a BSD-style
	license that can be found in the LICENSE file.
-->
<h1>Server</h1>



	<pre>package rev

var (
    MainRouter         *Router
    MainTemplateLoader *TemplateLoader
    MainWatcher        *Watcher
    Server             *http.Server
)

<span class="comment">// Run the server.</span>
<span class="comment">// This is called from the generated main file.</span>
<span class="comment">// If port is non-zero, use that.  Else, read the port from app.conf.</span>
func Run(port int) {
    address := Config.StringDefault(&#34;http.addr&#34;, &#34;&#34;)
    if port == 0 {
        port = Config.IntDefault(&#34;http.port&#34;, 9000)
    }

    MainRouter = NewRouter(path.Join(BasePath, &#34;conf&#34;, &#34;routes&#34;))
    MainTemplateLoader = NewTemplateLoader(TemplatePaths)

    if Config.BoolDefault(&#34;server.watcher&#34;, true) {
        MainWatcher = NewWatcher()
        MainWatcher.auditor = PluginNotifier{plugins}
        MainWatcher.Listen(MainTemplateLoader, MainTemplateLoader.paths...)
        MainWatcher.Listen(MainRouter, MainRouter.path)
    } else {

        MainTemplateLoader.Refresh()
        MainRouter.Refresh()
        plugins.OnRoutesLoaded(MainRouter)
    }

    Server = &amp;http.Server{
        Addr:    fmt.Sprintf(&#34;%s:%d&#34;, address, port),
        Handler: http.HandlerFunc(handle),
    }

    plugins.OnAppStart()

    go func() {
        time.Sleep(100 * time.Millisecond)
        fmt.Printf(&#34;Listening on port %d...\n&#34;, port)
    }()

    ERROR.Fatalln(&#34;Failed to listen:&#34;, Server.ListenAndServe())
}

<span class="comment">// The PluginNotifier glues the watcher and the plugin collection together.</span>
<span class="comment">// It audits refreshes and invokes the appropriate method to inform the plugins.</span>
type PluginNotifier struct {
    <span class="comment">// contains filtered or unexported fields</span>
}

func (pn PluginNotifier) OnRefresh(l Listener) {
    if l == MainRouter {
        pn.plugins.OnRoutesLoaded(MainRouter)
    }
}
</pre>






